<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Face Meme iOS</title>

  <script defer src="https://cdn.jsdelivr.net/npm/face-api.js"></script>

  <style>
    html, body {
      margin:0; padding:0;
      background:#000;
      height:100%;
    }
    .wrap {
      display:flex;
      flex-direction:column;
      height:100vh;
    }
    #videoArea, #memeArea {
      flex:1;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    #video {
      width:100%;
      height:100%;
      object-fit:cover;
      transform:scaleX(-1);
      background:#111;
    }
    #memeImg {
      max-width:100%;
      max-height:100%;
    }
    #startBtn {
      position:absolute;
      top:50%; left:50%;
      transform:translate(-50%, -50%);
      padding:16px 28px;
      background:#fff;
      color:#000;
      font-size:18px;
      border-radius:12px;
      z-index:999;
    }
    #msg {
      position:absolute;
      top:10px;
      left:10px;
      color:#fff;
    }
  </style>
</head>

<body>

<button id="startBtn">Kamerayı Başlat</button>

<div class="wrap">
  <div id="videoArea">
    <video id="video" autoplay muted playsinline></video>
    <div id="msg"></div>
  </div>
  <div id="memeArea">
    <img id="memeImg" src="">
  </div>
</div>

<script>
const startBtn = document.getElementById("startBtn");
const video = document.getElementById("video");
const memeImg = document.getElementById("memeImg");
const msg = document.getElementById("msg");

startBtn.addEventListener("click", async () => {
  startBtn.style.display = "none";
  msg.textContent = "Kamera açılıyor...";

  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: "user" },
      audio: false
    });
    video.srcObject = stream;
    msg.textContent = "Kamera açık";
  } catch (err) {
    msg.textContent = "Kamera açılamadı: " + err.message;
    console.error(err);
    return;
  }

  const MODEL_URL = "https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js/models";

  msg.textContent = "Model yükleniyor...";
  await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
  await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
  await faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL);
  msg.textContent = "Hazır";

  const MEMES = {
    happy: "meme-happy.png",
    surprised: "meme-surprised.png",
    fearful: "meme-shocked.png",
    sad: "meme-thinking.png",
    neutral: "meme-thinking.png",
    angry: "meme-thinking.png",
    disgusted: "meme-thinking.png"
  };

  video.addEventListener("playing", () => {
    setInterval(async () => {
      const res = await faceapi
        .detectSingleFace(video, new faceapi.TinyFaceDetectorOptions())
        .withFaceLandmarks()
        .withFaceExpressions();

      if (!res) return;

      const exp = res.expressions;
      let best = "";
      let bestVal = 0;

      Object.keys(exp).forEach(k => {
        if (exp[k] > bestVal) {
          bestVal = exp[k];
          best = k;
        }
      });

      if (MEMES[best]) {
        memeImg.src = MEMES[best];
      }
    }, 350);
  });
});
</script>

</body>
</html>
