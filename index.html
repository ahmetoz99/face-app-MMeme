<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Yüz İfadesine Göre Meme Gösterici</title>
  <style>
    html,body{height:100%;margin:0;font-family:Inter, system-ui, sans-serif;background:#111;color:#eee}
    .split{display:flex;height:100vh;width:100vw}
    .pane{flex:1;position:relative;overflow:hidden;display:flex;align-items:center;justify-content:center}
    .left{background:linear-gradient(180deg,#0b1220,#0f1724)}
    .right{background:#0b0b0b}

    video#webcam{max-width:100%;height:100%;object-fit:cover;transform:scaleX(-1)}
    canvas#overlay{position:absolute;left:0;top:0;width:100%;height:100%;pointer-events:none}

  .photo-box {
    position: relative;
    width: 90%;      /* photo-box genişliği */
    max-width: 400px; 
    height: 90%;     /* photo-box yüksekliği */
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
}

.photo-box img {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%); /* ortalama */
    width: 100%;    /* genişliği photo-box’a göre doldur */
    height: 100%;   /* yüksekliği de doldur */
    object-fit: cover;  /* taşmayı önler ve kutuyu doldurur */
    opacity: 0;
    transition: opacity 300ms ease, transform 300ms ease;
}

.photo-box img.show {
    opacity: 1;
    transform: translate(-50%, -50%);
}



    .controls{position:absolute;left:12px;top:12px;background:rgba(0,0,0,0.35);padding:10px;border-radius:10px;backdrop-filter:blur(4px)}
    .controls button{background:#1f2937;color:#fff;border:0;padding:8px 10px;border-radius:8px;cursor:pointer}
    .status{position:absolute;right:12px;bottom:12px;background:rgba(0,0,0,0.35);padding:8px 10px;border-radius:8px}

    @media(max-width:700px){
      .split{flex-direction:column}
      video#webcam{transform:none}
    }
  </style>
</head>
<body>
  <div class="split">
    <div class="pane left">
      <div class="controls">
        <button id="startBtn">Kamerayı Başlat</button>
      </div>
      <video id="webcam" autoplay muted playsinline></video>
      <canvas id="overlay"></canvas>
    </div>

    <div class="pane right">
      <div class="photo-box">
        <!-- Aşağıdaki resimler proje klasöründe bulunmalı: meme-happy.png, meme-shocked.png, meme-surprised.png, meme-thinking.png -->
        <img id="img-happy" src="meme-happy.png" alt="happy">
        <img id="img-shocked" src="meme-shocked.png" alt="shocked">
        <img id="img-surprised" src="meme-surprised.png" alt="surprised">
        <img id="img-thinking" src="meme-thinking.png" alt="thinking">
      </div>
      <div class="status" id="status">Durum: Bekleniyor</div>
    </div>
  </div>

  <!-- face-api.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
  <script>
    // Bu proje için face-api model dosyalarını ./models klasörüne koymanız gerekir.
    // (models klasörünü GitHub'a ekleyebilir veya GitHub Pages kullanırken relative path ile çalıştırabilirsiniz.)

    const video = document.getElementById('webcam');
    const overlay = document.getElementById('overlay');
    const overlayCtx = overlay.getContext('2d');
    const startBtn = document.getElementById('startBtn');
    const statusEl = document.getElementById('status');

    const images = {
      happy: document.getElementById('img-happy'),
      shocked: document.getElementById('img-shocked'),
      surprised: document.getElementById('img-surprised'),
      thinking: document.getElementById('img-thinking')
    };

    let detecting = false;

   let lastShown = null;
let lastExpr = null;
const minShowTime = 2000; // 2000ms = 2 saniye

function showImageWithDelay(key){
    const now = Date.now();
    if(lastExpr !== key){
        // yeni ifade gelmiş
        lastExpr = key;
        lastShown = now;
        showImage(key);
    } else if(now - lastShown > minShowTime){
        // aynı ifade en az minShowTime gösterildi, güncellenebilir
        showImage(key);
    }
}

// eski showImage fonksiyonu hâlâ lazım (showImageWithDelay içinde çağrılıyor)
function showImage(key){
    Object.values(images).forEach(img => img.classList.remove('show'));
    const target = images[key];
    if(target){
        target.classList.add('show');
    }
}


    async function initModels(){
      statusEl.textContent = 'Durum: Modeller yükleniyor...';
      // models klasörünüzde aşağıdaki dosyalar olmalı: tiny_face_detector_model-weights_manifest.json, face_expression_model-weights_manifest.json vb.
      // Bu modelleri face-api.js github reposundan indirebilirsiniz ve ./models içine koyabilirsiniz.
      await faceapi.nets.tinyFaceDetector.loadFromUri('./models');
      await faceapi.nets.faceExpressionNet.loadFromUri('./models');
      statusEl.textContent = 'Durum: Modeller yüklendi.';
    }

    async function startCamera(){
      try{
        const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'user'}, audio:false});
        video.srcObject = stream;
        await video.play();
        overlay.width = video.videoWidth;
        overlay.height = video.videoHeight;
        overlay.style.width = video.offsetWidth + 'px';
        overlay.style.height = video.offsetHeight + 'px';
        statusEl.textContent = 'Durum: Kamera çalışıyor — İfade algılanıyor...';
        detecting = true;
        detectLoop();
      }catch(err){
        console.error(err);
        statusEl.textContent = 'Hata: Kameraya erişilemedi. İzinleri kontrol edin.';
      }
    }

   function mapExpressionToImage(expr){
    let best = {name:'neutral', value:0};
    for(const k in expr){
        if(expr[k] > best.value){ best = {name:k, value:expr[k]}; }
    }
    switch(best.name){
        case 'happy': return 'happy';
        case 'sad': return 'sad';
        case 'angry': return 'angry';
        case 'fearful': return 'fearful';
        case 'surprised': return 'surprised';
        case 'neutral': return 'thinking';
        default: return 'thinking';
    }
}


    async function detectLoop(){
      const options = new faceapi.TinyFaceDetectorOptions({inputSize:224, scoreThreshold:0.5});
      while(detecting){
        if(video.readyState < 2){
          await new Promise(r=>setTimeout(r,100));
          continue;
        }
        const result = await faceapi.detectSingleFace(video, options).withFaceExpressions();
        overlayCtx.clearRect(0,0,overlay.width,overlay.height);
        if(result){
          // kutu ve ifadeyi çiz
          const resized = faceapi.resizeResults(result, {width:overlay.width, height:overlay.height});
          const box = resized.detection.box;
          overlayCtx.strokeStyle = '#00ff99';
          overlayCtx.lineWidth = 2;
          overlayCtx.strokeRect(box.x, box.y, box.width, box.height);

          const expr = resized.expressions;
         const mapped = mapExpressionToImage(expr);
showImageWithDelay(mapped);
statusEl.textContent = `Durum: ${mapped} (ifadeye göre seçildi)`;

        } else {
          // algılanmamışsa thinking (düşünen) göster
          showImage('thinking');
          statusEl.textContent = 'Durum: Yüz algılanamadı';
        }
        await new Promise(r=>setTimeout(r,200)); // 200ms ara
      }
    }

    // Başlat butonu
    startBtn.addEventListener('click', async ()=>{
      startBtn.disabled = true;
      try{
        await initModels();
        await startCamera();
      }catch(e){
        console.error(e);
        statusEl.textContent = 'Hata: Modeller yüklenirken veya kamera başlatılırken hata oluştu. Konsolu kontrol edin.';
        startBtn.disabled = false;
      }
    });

    // Sayfa kapanırken kamerayı durdur
    window.addEventListener('beforeunload', ()=>{
      detecting = false;
      const s = video.srcObject;
      if(s){
        s.getTracks().forEach(t=>t.stop());
      }
    });
  </script>

  <!-- Kullanım notları:
       1) Proje köküne (aynı klasöre) aşağıdaki resimleri koyun: meme-happy.png, meme-shocked.png, meme-surprised.png, meme-thinking.png
       2) face-api.js modellerini ./models klasörüne indirin (face-api.js repo'sundan tiny face detector ve face expression modelleri).
       3) Chrome'da local olarak çalıştırmak için dosyayı doğrudan açmak yerine basit bir HTTP sunucu kullanın (ör. VSCode Live Server veya `python -m http.server`).
       4) GitHub Pages üzerinde barındırmak isterseniz, tüm dosyaları (html + images + models) repo'ya koyup Pages'ı etkinleştirin.
  -->
</body>
</html>






