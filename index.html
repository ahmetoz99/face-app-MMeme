<!doctype html>
 muted playsinline></video>
      <canvas id="overlay"></canvas>
    </div>

    <div class="pane right">
      <div class="photo-box">
        <!-- Aşağıdaki resimler proje klasöründe bulunmalı: meme-happy.png, meme-shocked.png, meme-surprised.png, meme-thinking.png -->
        <img id="img-happy" src="meme-happy.png" alt="happy">
        <img id="img-shocked" src="meme-shocked.png" alt="shocked">
        <img id="img-surprised" src="meme-surprised.png" alt="surprised">
        <img id="img-thinking" src="meme-thinking.png" alt="thinking">
      </div>
      <div class="status" id="status">Durum: Bekleniyor</div>
    </div>
  </div>

  <!-- face-api.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
  <script>
    // Bu proje için face-api model dosyalarını ./models klasörüne koymanız gerekir.
    // (models klasörünü GitHub'a ekleyebilir veya GitHub Pages kullanırken relative path ile çalıştırabilirsiniz.)

    const video = document.getElementById('webcam');
    const overlay = document.getElementById('overlay');
    const overlayCtx = overlay.getContext('2d');
    const startBtn = document.getElementById('startBtn');
    const statusEl = document.getElementById('status');

    const images = {
      happy: document.getElementById('img-happy'),
      shocked: document.getElementById('img-shocked'),
      surprised: document.getElementById('img-surprised'),
      thinking: document.getElementById('img-thinking')
    };

    let detecting = false;

    function showImage(key){
      // tümünü gizle
      Object.values(images).forEach(img => img.classList.remove('show'));
      const target = images[key];
      if(target){
        target.classList.add('show');
      }
    }

    async function initModels(){
      statusEl.textContent = 'Durum: Modeller yükleniyor...';
      // models klasörünüzde aşağıdaki dosyalar olmalı: tiny_face_detector_model-weights_manifest.json, face_expression_model-weights_manifest.json vb.
      // Bu modelleri face-api.js github reposundan indirebilirsiniz ve ./models içine koyabilirsiniz.
      await faceapi.nets.tinyFaceDetector.loadFromUri('./models');
      await faceapi.nets.faceExpressionNet.loadFromUri('./models');
      statusEl.textContent = 'Durum: Modeller yüklendi.';
    }

    async function startCamera(){
      try{
        const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'user'}, audio:false});
        video.srcObject = stream;
        await video.play();
        overlay.width = video.videoWidth;
        overlay.height = video.videoHeight;
        overlay.style.width = video.offsetWidth + 'px';
        overlay.style.height = video.offsetHeight + 'px';
        statusEl.textContent = 'Durum: Kamera çalışıyor — İfade algılanıyor...';
        detecting = true;
        detectLoop();
      }catch(err){
        console.error(err);
        statusEl.textContent = 'Hata: Kameraya erişilemedi. İzinleri kontrol edin.';
      }
    }

    function mapExpressionToImage(expr){
      // face-api expressions: neutral, happy, sad, angry, fearful, disgusted, surprised
      // Basit eşleme:
      if(!expr) return 'thinking';
      // en yüksek expression anahtarını al
      let best = {name:'neutral', value:0};
      for(const k in expr){
        if(expr[k] > best.value){ best = {name:k, value:expr[k]}; }
      }
      const name = best.name;
      // Eşleme kurgusu
      if(name === 'happy') return 'happy';
      if(name === 'surprised') return 'surprised';
      if(name === 'fearful') return 'shocked';
      if(name === 'angry' || name === 'sad' || name === 'disgusted') return 'shocked';
      if(name === 'neutral') return 'thinking';
      return 'thinking';
    }

    async function detectLoop(){
      const options = new faceapi.TinyFaceDetectorOptions({inputSize:224, scoreThreshold:0.5});
      while(detecting){
        if(video.readyState < 2){
          await new Promise(r=>setTimeout(r,100));
          continue;
        }
        const result = await faceapi.detectSingleFace(video, options).withFaceExpressions();
        overlayCtx.clearRect(0,0,overlay.width,overlay.height);
        if(result){
          // kutu ve ifadeyi çiz
          const resized = faceapi.resizeResults(result, {width:overlay.width, height:overlay.height});
          const box = resized.detection.box;
          overlayCtx.strokeStyle = '#00ff99';
          overlayCtx.lineWidth = 2;
          overlayCtx.strokeRect(box.x, box.y, box.width, box.height);

          const expr = resized.expressions;
          const mapped = mapExpressionToImage(expr);
          showImage(mapped);
          statusEl.textContent = `Durum: ${mapped} (ifadeye göre seçildi)`;
        } else {
          // algılanmamışsa thinking (düşünen) göster
          showImage('thinking');
          statusEl.textContent = 'Durum: Yüz algılanamadı';
        }
        await new Promise(r=>setTimeout(r,200)); // 200ms ara
      }
    }

    // Başlat butonu
    startBtn.addEventListener('click', async ()=>{
      startBtn.disabled = true;
      try{
        await initModels();
        await startCamera();
      }catch(e){
        console.error(e);
        statusEl.textContent = 'Hata: Modeller yüklenirken veya kamera başlatılırken hata oluştu. Konsolu kontrol edin.';
        startBtn.disabled = false;
      }
    });

    // Sayfa kapanırken kamerayı durdur
    window.addEventListener('beforeunload', ()=>{
      detecting = false;
      const s = video.srcObject;
      if(s){
        s.getTracks().forEach(t=>t.stop());
      }
    });
  </script>

  <!-- Kullanım notları:
       1) Proje köküne (aynı klasöre) aşağıdaki resimleri koyun: meme-happy.png, meme-shocked.png, meme-surprised.png, meme-thinking.png
       2) face-api.js modellerini ./models klasörüne indirin (face-api.js repo'sundan tiny face detector ve face expression modelleri).
       3) Chrome'da local olarak çalıştırmak için dosyayı doğrudan açmak yerine basit bir HTTP sunucu kullanın (ör. VSCode Live Server veya `python -m http.server`).
       4) GitHub Pages üzerinde barındırmak isterseniz, tüm dosyaları (html + images + models) repo'ya koyup Pages'ı etkinleştirin.
  -->
</body>
</html>


