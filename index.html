<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Face Meme iOS Fix</title>

  <script defer src="https://cdn.jsdelivr.net/npm/face-api.js"></script>

  <style>
    html, body {
      margin:0; padding:0;
      background:#000;
      height:100%;
    }
    .wrap {
      display:flex;
      flex-direction:column;
      height:100vh;
    }
    #videoArea, #memeArea {
      flex:1;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    #video {
      width:100%;
      height:100%;
      object-fit:cover;
      transform:scaleX(-1); /* selfie */
      background:#111;
    }
    #memeArea {
      background:#111;
    }
    #memeImg {
      max-width:100%;
      max-height:100%;
    }
    #msg {
      position:absolute;
      top:10px;
      left:10px;
      color:#fff;
      font-size:14px;
      background:rgba(0,0,0,0.5);
      padding:4px 8px;
      border-radius:6px;
    }
  </style>
</head>

<body>
<div class="wrap">
  <div id="videoArea">
    <video id="video" autoplay muted playsinline></video>
    <div id="msg">Kamera yükleniyor...</div>
  </div>
  <div id="memeArea">
    <img id="memeImg" src="" />
  </div>
</div>

<script>
(async () => {
  const video = document.getElementById("video");
  const memeImg = document.getElementById("memeImg");
  const msg = document.getElementById("msg");

  // iOS için garanti dokunma tetikleyici
  document.body.addEventListener("touchstart", () => {
    if (video.paused) video.play().catch(()=>{});
  });

  // Kamera başlat
  async function startCamera() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: "user" },
        audio: false
      });
      video.srcObject = stream;
      msg.textContent = "Kamera açık";
    } catch (err) {
      msg.textContent = "Kamera açılamadı: " + err.message;
      console.error(err);
    }
  }

  await startCamera();

  // MODELLER
  const MODEL_URL = "https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js/models";

  await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
  await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
  await faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL);

  msg.textContent = "Mimik tespiti hazır";

  const MEMES = {
    happy: "meme-happy.png",
    surprised: "meme-surprised.png",
    fearful: "meme-shocked.png",
    sad: "meme-thinking.png",
    neutral: "meme-thinking.png",
    angry: "meme-thinking.png",
    disgusted: "meme-thinking.png"
  };

  let current = "";

  video.addEventListener("playing", () => {
    setInterval(async () => {
      const result = await faceapi
        .detectSingleFace(video, new faceapi.TinyFaceDetectorOptions())
        .withFaceLandmarks()
        .withFaceExpressions();

      if (!result) return;

      const exp = result.expressions;

      let best = "";
      let bestValue = 0;

      Object.keys(exp).forEach(k => {
        if (exp[k] > bestValue) {
          bestValue = exp[k];
          best = k;
        }
      });

      if (MEMES[best] && MEMES[best] !== current) {
        current = MEMES[best];
        memeImg.src = current;
      }
    }, 250);
  });

})();
</script>

</body>
</html>
